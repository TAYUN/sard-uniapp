# 瀑布流切换列数闪烁问题修复

## 问题描述

在切换瀑布流列数时，项目会出现闪烁现象，主要表现为：

1. 项目先变为不可见（opacity: 0）
2. 然后重新出现，造成明显的闪烁效果
3. 用户体验不佳，视觉上不够流畅

## 问题根因分析

1. **状态重置过于激进**：在 `fullReflow` 时，所有项目的 `visible` 状态都被重置为 `false`
2. **动画时间过长**：0.4s 的动画持续时间让闪烁更加明显
3. **缺乏平滑过渡机制**：没有区分普通重排和列数变化的重排

## 解决方案

### 1. 引入重排状态标记

**新增 `isReflowing` 属性**：

```typescript
export interface WaterfallItemInfo {
  // ... 其他属性
  isReflowing?: boolean // 是否正在重排（用于平滑过渡）
}
```

### 2. 实现平滑重排机制

**区分重排类型**：

- 普通重排：重置 `visible` 状态，正常动画
- 平滑重排：保持 `visible` 状态，设置 `isReflowing` 标记

```typescript
const smoothReflow = throttle(async () => {
  // 标记所有项目为重排状态，但保持可见
  items.forEach((item) => {
    item.isReflowing = true
    item.animationDelay = 0
  })

  // 立即开始重排
  resetColumnsHeight()
  pendingItems.length = 0
  getItemHeight(items, true) // 使用平滑过渡模式
  pendingItems.push(...items)
  processQueue()
}, 100)
```

### 3. 优化样式类名计算

**保持可见性**：

```typescript
const waterfallItemClass = computed(() => {
  return classNames(
    bem.b(),
    bem.m('show', item.visible || item.isReflowing), // 重排时也保持可见
    bem.m('reflowing', item.isReflowing), // 重排状态类名
    itemId,
    props.rootClass,
  )
})
```

### 4. 添加重排专用样式

**更快的过渡效果**：

```scss
@include m(reflowing) {
  // 重排状态：保持可见，使用更快的过渡
  opacity: 1;
  transition:
    opacity var(--sar-waterfall-reflow-duration) ease-out,
    transform var(--sar-waterfall-reflow-duration)
      cubic-bezier(0.25, 0.46, 0.45, 0.94);
}
```

### 5. 优化动画时间

**缩短动画持续时间**：

```scss
:root {
  --sar-waterfall-duration: 0.25s; // 普通动画
  --sar-waterfall-reflow-duration: 0.15s; // 重排动画
}
```

### 6. 智能重排触发

**根据变化类型选择重排方式**：

```typescript
watch(
  [() => props.columns, () => props.columnGap, () => props.rowGap],
  (newValues, oldValues) => {
    const [newColumns] = newValues
    const [oldColumns] = oldValues || []

    setTimeout(() => {
      if (columns.length !== newColumns) {
        initColumns()
        // 列数变化使用平滑重排
        if (oldColumns && oldColumns !== newColumns) {
          smoothReflow()
        } else {
          // 其他情况使用普通重排
          fullReflow()
        }
      }
    }, 50)
  },
)
```

### 7. 状态清理

**重排完成后清除状态**：

```typescript
setTimeout(
  () => {
    item.visible = true
    item.isReflowing = false // 清除重排状态
  },
  Math.min(item.animationDelay || 0, 500),
)
```

## 修复效果

### 修复前

- ❌ 切换列数时项目明显闪烁
- ❌ 动画时间过长，体验不佳
- ❌ 所有重排都使用相同的激进策略

### 修复后

- ✅ 切换列数时项目保持可见，平滑过渡
- ✅ 缩短动画时间，提升响应性
- ✅ 区分重排类型，智能选择策略
- ✅ 添加重排状态指示，用户感知更好

## 测试页面

创建了专门的测试页面 `SmoothReflow.vue`：

- 列数快速切换测试
- 间距调整测试
- 手动重排测试
- 动态添加项目测试

## 技术要点

1. **状态管理**：通过 `isReflowing` 标记区分重排状态
2. **样式优化**：使用更短的动画时间和专用样式
3. **智能触发**：根据变化类型选择合适的重排策略
4. **用户体验**：保持视觉连续性，减少突兀感

这个修复方案有效解决了瀑布流切换列数时的闪烁问题，提供了更流畅的用户体验。
