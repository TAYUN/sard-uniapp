# ç€‘å¸ƒæµæ··åˆæ¶æ„è®¾è®¡è®¨è®º

## é—®é¢˜èƒŒæ™¯

ç”¨æˆ·å¸Œæœ›æ•´åˆä¸¤å¥—ç€‘å¸ƒæµæ’ç‰ˆç³»ç»Ÿï¼š

1. **processQueue (DOMæµ‹é‡æ¨¡å¼)** - ç”¨äºåˆæ¬¡æ’ç‰ˆï¼Œæ”¯æŒå¼‚æ­¥åŠ è½½å’Œå®æ—¶DOMæµ‹é‡
2. **use-waterfall-reflow (çº¯ç®—æ³•æ¨¡å¼)** - ç”¨äºåç»­æ“ä½œï¼ŒåŸºäºå¿«ç…§çš„çº¯æ•°å­¦è®¡ç®—

**ç›®æ ‡**ï¼šåˆæ¬¡æ’ç‰ˆä½¿ç”¨DOMæµ‹é‡ä¿è¯å‡†ç¡®æ€§ï¼Œåç»­åˆ é™¤ç­‰æ“ä½œä½¿ç”¨çº¯ç®—æ³•æå‡æ€§èƒ½ã€‚

## ä¸¤å¥—ç³»ç»Ÿå¯¹æ¯”åˆ†æ

### processQueue (DOMæµ‹é‡æ¨¡å¼)

**ä¼˜åŠ¿ï¼š**

- å®æ—¶DOMæµ‹é‡ï¼Œé«˜åº¦å‡†ç¡®
- æ”¯æŒå¼‚æ­¥åŠ è½½ï¼Œç­‰å¾…å›¾ç‰‡ç­‰èµ„æº
- æ¸è¿›å¼æ¸²æŸ“ï¼Œç”¨æˆ·ä½“éªŒå¥½
- å¤„ç†å¤æ‚å†…å®¹ï¼ˆæ–‡å­—æ¢è¡Œã€åŠ¨æ€å†…å®¹ï¼‰

**åŠ£åŠ¿ï¼š**

- æ€§èƒ½å¼€é”€å¤§ï¼ˆDOMæŸ¥è¯¢ï¼‰
- å¼‚æ­¥å¤æ‚åº¦é«˜
- é‡æ’æ—¶éœ€è¦é‡æ–°æµ‹é‡

### use-waterfall-reflow (çº¯ç®—æ³•æ¨¡å¼)

**ä¼˜åŠ¿ï¼š**

- çº¯æ•°å­¦è®¡ç®—ï¼Œæ€§èƒ½æé«˜
- åŒæ­¥æ‰§è¡Œï¼Œé€»è¾‘ç®€å•
- æ”¯æŒå„ç§æ“ä½œï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
- å¯é¢„æµ‹çš„ç»“æœ

**åŠ£åŠ¿ï¼š**

- ä¾èµ–å‡†ç¡®çš„åˆå§‹å¿«ç…§
- æ— æ³•å¤„ç†åŠ¨æ€å†…å®¹å˜åŒ–
- éœ€è¦é¢„çŸ¥æ‰€æœ‰é¡¹ç›®å°ºå¯¸

## æ•´åˆæ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆ1: åˆ†é˜¶æ®µæ··åˆæ¨¡å¼

```typescript
class HybridWaterfallManager {
  private mode: 'dom' | 'algorithm' = 'dom'
  private domManager: DOMLayoutManager
  private algorithmManager: WaterfallManager
  private snapshot: SnapshotItem[] = []

  // åˆæ¬¡æ’ç‰ˆï¼šDOMæ¨¡å¼
  async initialLayout(items: WaterfallItemInfo[]) {
    this.mode = 'dom'
    await this.domManager.processQueue(items)

    // æ’ç‰ˆå®Œæˆåç”Ÿæˆå¿«ç…§
    this.generateSnapshot()
    this.mode = 'algorithm'
  }

  // ç”Ÿæˆå¿«ç…§
  private generateSnapshot() {
    this.snapshot = this.domManager.items.map((item) => ({
      id: item.id,
      aspect: item.width / item.height, // ä»DOMè·å–çœŸå®å®½é«˜æ¯”
      order: item.index,
    }))
    this.algorithmManager.initSnapshot(this.snapshot)
  }

  // åç»­æ“ä½œï¼šç®—æ³•æ¨¡å¼
  removeItem(itemId: string | number) {
    if (this.mode === 'algorithm') {
      return this.algorithmManager.removeItem(itemId)
    }
    // å¦‚æœè¿˜åœ¨DOMæ¨¡å¼ï¼Œé™çº§åˆ°DOMæ“ä½œ
    return this.domManager.removeItem(itemId)
  }
}
```

### æ–¹æ¡ˆ2: æ™ºèƒ½åˆ‡æ¢æ¨¡å¼

```typescript
class SmartWaterfallManager {
  private shouldUseAlgorithm(): boolean {
    return (
      this.isSnapshotReady &&
      !this.hasPendingLoads &&
      !this.hasLayoutParamsChanged
    )
  }

  async removeItem(itemId: string | number) {
    if (this.shouldUseAlgorithm()) {
      // ä½¿ç”¨çº¯ç®—æ³•
      return this.algorithmManager.removeItem(itemId)
    } else {
      // é™çº§åˆ°DOMæ¨¡å¼
      return this.domManager.removeItem(itemId)
    }
  }
}
```

## å…³é”®æŒ‘æˆ˜åˆ†æ

### 1. æ•°æ®åŒæ­¥é—®é¢˜

```typescript
// ä¸¤å¥—ç³»ç»Ÿçš„æ•°æ®ç»“æ„ä¸åŒ
interface WaterfallItemInfo {
  // DOMæ¨¡å¼
  loaded: boolean
  height: number // å®é™…DOMé«˜åº¦
  top: number
  left: number
}

interface SnapshotItem {
  // ç®—æ³•æ¨¡å¼
  aspect: number // å®½é«˜æ¯”
  order: number
}
```

**è§£å†³æ–¹æ¡ˆï¼š** å»ºç«‹æ˜ å°„å…³ç³»

```typescript
class DataBridge {
  private itemMap = new Map<
    string,
    {
      domItem: WaterfallItemInfo
      snapshotItem: SnapshotItem
    }
  >()

  syncFromDomToSnapshot(domItem: WaterfallItemInfo) {
    const snapshotItem = {
      id: domItem.id,
      aspect: domItem.width / domItem.height,
      order: domItem.index,
    }
    this.itemMap.set(domItem.id, { domItem, snapshotItem })
  }
}
```

### 2. çŠ¶æ€åˆ‡æ¢æ—¶æœº

```typescript
// ä»€ä¹ˆæ—¶å€™ä»DOMæ¨¡å¼åˆ‡æ¢åˆ°ç®—æ³•æ¨¡å¼ï¼Ÿ
const canSwitchToAlgorithm = () => {
  return (
    allItemsLoaded && // æ‰€æœ‰é¡¹ç›®åŠ è½½å®Œæˆ
    !hasLayoutParamsChanged && // å¸ƒå±€å‚æ•°æœªå˜åŒ–
    snapshotGenerated && // å¿«ç…§å·²ç”Ÿæˆ
    !hasPendingOperations // æ— å¾…å¤„ç†æ“ä½œ
  )
}
```

### 3. å›é€€æœºåˆ¶

```typescript
// ç®—æ³•æ¨¡å¼å¤±è´¥æ—¶å¦‚ä½•å›é€€ï¼Ÿ
class FallbackManager {
  async executeWithFallback<T>(
    algorithmFn: () => T,
    domFn: () => Promise<T>,
  ): Promise<T> {
    try {
      if (this.canUseAlgorithm()) {
        return algorithmFn()
      }
    } catch (error) {
      console.warn('ç®—æ³•æ¨¡å¼å¤±è´¥ï¼Œå›é€€åˆ°DOMæ¨¡å¼', error)
    }
    return await domFn()
  }
}
```

## å…·ä½“æ•´åˆç­–ç•¥

### é˜¶æ®µ1: åˆæ¬¡æ’ç‰ˆï¼ˆDOMæ¨¡å¼ï¼‰

```typescript
async initialRender() {
  // 1. ä½¿ç”¨processQueueè¿›è¡ŒDOMæµ‹é‡æ’ç‰ˆ
  await this.processQueue()

  // 2. æ’ç‰ˆå®Œæˆåç”Ÿæˆå¿«ç…§
  this.generateSnapshot()

  // 3. åˆ‡æ¢åˆ°ç®—æ³•æ¨¡å¼
  this.switchToAlgorithmMode()
}
```

### é˜¶æ®µ2: å¢åˆ æ“ä½œï¼ˆç®—æ³•æ¨¡å¼ï¼‰

```typescript
removeItem(itemId: string | number) {
  // 1. æ£€æŸ¥æ˜¯å¦å¯ä»¥ä½¿ç”¨ç®—æ³•æ¨¡å¼
  if (this.canUseAlgorithm()) {
    // 2. ä½¿ç”¨çº¯ç®—æ³•è®¡ç®—
    const result = this.algorithmManager.removeItem(itemId)

    // 3. åŒæ­¥æ›´æ–°DOMé¡¹ç›®çŠ¶æ€
    this.syncAlgorithmResultToDom(result)

    return result
  }

  // 4. é™çº§åˆ°DOMæ¨¡å¼
  return this.domRemoveItem(itemId)
}
```

### é˜¶æ®µ3: å‚æ•°å˜åŒ–ï¼ˆé‡æ–°DOMæ¨¡å¼ï¼‰

```typescript
onLayoutParamsChange() {
  // 1. åˆ‡æ¢å›DOMæ¨¡å¼
  this.switchToDomMode()

  // 2. é‡æ–°æ’ç‰ˆ
  this.fullReflow()

  // 3. é‡æ–°ç”Ÿæˆå¿«ç…§
  this.generateSnapshot()

  // 4. å†æ¬¡åˆ‡æ¢åˆ°ç®—æ³•æ¨¡å¼
  this.switchToAlgorithmMode()
}
```

## æ¸è¿›å¼å¿«ç…§æ„å»ºæ–¹æ¡ˆ

åŸºäºç¬¬äºŒä¸ªé—®é¢˜çš„è®¨è®ºï¼Œæå‡ºäº†æ¸è¿›å¼å¿«ç…§æ„å»ºçš„æ”¹è¿›æ–¹æ¡ˆï¼š

### æ¸è¿›å¼å¿«ç…§ç®¡ç†å™¨

```typescript
export interface ProgressiveSnapshotOptions {
  enableProgressive?: boolean // æ˜¯å¦å¯ç”¨æ¸è¿›å¼æ¨¡å¼
  minItemsForAlgorithm?: number // åˆ‡æ¢åˆ°ç®—æ³•æ¨¡å¼çš„æœ€å°é¡¹ç›®æ•°
  autoSwitchMode?: boolean // æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢æ¨¡å¼
}

export function useWaterfallReflow(
  options: UseWaterfallReflowOptions & ProgressiveSnapshotOptions,
) {
  const {
    containerWidth,
    columns,
    columnGap = ref(10),
    rowGap = ref(10),
    immediate = true,
    enableProgressive = false,
    minItemsForAlgorithm = 10,
    autoSwitchMode = true,
  } = options

  const manager = new WaterfallManager()
  const layoutItems = ref<LayoutItem[]>([])
  const containerHeight = ref(0)
  const isInitialized = ref(false)

  // æ–°å¢ï¼šæ¸è¿›å¼çŠ¶æ€ç®¡ç†
  const mode = ref<'progressive' | 'algorithm'>('progressive')
  const snapshotItems = ref<WaterfallItem[]>([]) // å·²æ·»åŠ åˆ°å¿«ç…§çš„é¡¹ç›®
  const pendingDomItems = ref<WaterfallItem[]>([]) // ç­‰å¾…DOMæ’ç‰ˆçš„é¡¹ç›®

  /**
   * æ¸è¿›å¼æ·»åŠ å¿«ç…§é¡¹ç›®
   */
  const addSnapshotItem = (item: WaterfallItem) => {
    if (!enableProgressive) return

    // æ·»åŠ åˆ°å¿«ç…§åˆ—è¡¨
    snapshotItems.value.push(item)

    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªé¡¹ç›®ï¼Œåˆå§‹åŒ–ç®¡ç†å™¨
    if (snapshotItems.value.length === 1) {
      manager.initSnapshot([item])
      isInitialized.value = true
    } else {
      // è¿½åŠ åˆ°ç°æœ‰å¿«ç…§
      manager.appendItem(item)
    }

    // æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆ‡æ¢åˆ°ç®—æ³•æ¨¡å¼
    if (autoSwitchMode && snapshotItems.value.length >= minItemsForAlgorithm) {
      switchToAlgorithmMode()
    }

    // æ›´æ–°å¸ƒå±€
    executeReflow()
  }

  /**
   * åˆ‡æ¢åˆ°ç®—æ³•æ¨¡å¼
   */
  const switchToAlgorithmMode = () => {
    if (mode.value === 'algorithm') return

    mode.value = 'algorithm'
    console.log(`åˆ‡æ¢åˆ°ç®—æ³•æ¨¡å¼ï¼Œå½“å‰å¿«ç…§é¡¹ç›®æ•°: ${snapshotItems.value.length}`)
  }

  return {
    // åŸæœ‰æ¥å£ä¿æŒä¸å˜
    layoutItems: readonly(layoutItems),
    containerHeight: readonly(containerHeight),
    isInitialized: readonly(isInitialized),

    // æ–°å¢ï¼šæ¸è¿›å¼æ¥å£
    mode: readonly(mode),
    snapshotItems: readonly(snapshotItems),
    addSnapshotItem,
    switchToAlgorithmMode,

    // åŸæœ‰æ–¹æ³•
    initSnapshot,
    initialize,
    reflow,
    insertItem,
    appendItem,
    removeItem,
    replaceItem,
    batchUpdate,
    getSnapshot,
    getParams,
  }
}
```

### ä¸ processQueue é›†æˆ

```typescript
const processQueue = async () => {
  // ... åŸæœ‰é€»è¾‘

  while (pendingItems.length > 0) {
    const item = pendingItems[0]

    // ç­‰å¾…åŠ è½½å®Œæˆ
    if (!item.loaded) {
      await new Promise<void>((resolve) => {
        const unwatch = watch(
          () => item.loaded,
          (newLoaded) => {
            if (newLoaded) {
              unwatch()
              resolve()
            }
          },
          { immediate: true },
        )
      })
    }

    // DOM æ’ç‰ˆé€»è¾‘
    const currentMinColumn = getMinColumn()
    item.top = currentMinColumn.height + props.rowGap
    item.left =
      (props.columnGap + columnWidth.value) * currentMinColumn.colIndex

    const targetColumnIndex = currentMinColumn.colIndex
    const newHeight = item.top + item.height
    columns[targetColumnIndex].height = newHeight

    item.visible = true

    // ğŸ”¥ å…³é”®ï¼šæ·»åŠ åˆ°æ¸è¿›å¼å¿«ç…§
    addSnapshotItem({
      id: item.id || item.index,
      width: columnWidth.value, // ä½¿ç”¨è®¡ç®—å‡ºçš„åˆ—å®½
      height: item.height, // ä½¿ç”¨DOMæµ‹é‡çš„é«˜åº¦
      // å¯ä»¥æ·»åŠ æ›´å¤šå…ƒæ•°æ®
      domTop: item.top,
      domLeft: item.left,
      columnIndex: targetColumnIndex,
    })

    pendingItems.shift()
  }

  // å¤„ç†å®Œæˆåçš„é€»è¾‘
  containerHeight.value = Math.max(...columns.map((col) => col.height), 0)

  // æ£€æŸ¥æ˜¯å¦å¯ä»¥å®Œå…¨åˆ‡æ¢åˆ°ç®—æ³•æ¨¡å¼
  if (pendingItems.length === 0 && items.length >= 10) {
    switchToAlgorithmMode()
  }
}
```

### æ™ºèƒ½æ¨¡å¼åˆ‡æ¢

```typescript
/**
 * æ™ºèƒ½å†³ç­–ï¼šä½¿ç”¨å“ªç§æ¨¡å¼å¤„ç†æ“ä½œ
 */
const shouldUseAlgorithm = (operation: string) => {
  const conditions = {
    hasEnoughSnapshot: snapshotItems.value.length >= minItemsForAlgorithm,
    noLayoutParamsChange: !layoutParamsChanged.value,
    noPendingLoads: pendingDomItems.value.length === 0,
    supportedOperation: ['remove', 'insert', 'replace'].includes(operation),
  }

  return Object.values(conditions).every(Boolean)
}

/**
 * æ··åˆæ¨¡å¼åˆ é™¤é¡¹ç›®
 */
const hybridRemoveItem = (itemId: string | number) => {
  if (shouldUseAlgorithm('remove')) {
    // ä½¿ç”¨ç®—æ³•æ¨¡å¼
    console.log('ä½¿ç”¨ç®—æ³•æ¨¡å¼åˆ é™¤é¡¹ç›®')
    const result = manager.removeItem(itemId)
    layoutItems.value = result.items
    containerHeight.value = result.containerHeight

    // åŒæ­¥æ›´æ–°å¿«ç…§åˆ—è¡¨
    const index = snapshotItems.value.findIndex((item) => item.id === itemId)
    if (index !== -1) {
      snapshotItems.value.splice(index, 1)
    }

    return result
  } else {
    // é™çº§åˆ°DOMæ¨¡å¼
    console.log('é™çº§åˆ°DOMæ¨¡å¼åˆ é™¤é¡¹ç›®')
    throw new Error('éœ€è¦ä½¿ç”¨DOMæ¨¡å¼å¤„ç†ï¼Œè¯·è°ƒç”¨åŸå§‹åˆ é™¤æ–¹æ³•')
  }
}
```

## å…³é”®æŠ€æœ¯ç‚¹

### 1. å¿«ç…§æ•°æ®è½¬æ¢

```typescript
// DOMé¡¹ç›® â†’ å¿«ç…§é¡¹ç›®
const domItemToSnapshot = (
  domItem: WaterfallItemInfo,
  columnWidth: number,
): WaterfallItem => {
  return {
    id: domItem.id || domItem.index,
    width: columnWidth, // ç»Ÿä¸€ä½¿ç”¨åˆ—å®½
    height: domItem.height, // ä½¿ç”¨DOMæµ‹é‡çš„çœŸå®é«˜åº¦
    // ä¿å­˜DOMæ’ç‰ˆç»“æœä½œä¸ºéªŒè¯
    _domResult: {
      top: domItem.top,
      left: domItem.left,
      columnIndex: Math.round(domItem.left / (columnWidth + columnGap)),
    },
  }
}
```

### 2. æ¨¡å¼åˆ‡æ¢æ—¶æœº

```typescript
const checkModeSwitch = () => {
  const canSwitch =
    snapshotItems.value.length >= minItemsForAlgorithm && // æœ‰è¶³å¤Ÿçš„å¿«ç…§
    pendingItems.length === 0 && // æ²¡æœ‰å¾…å¤„ç†é¡¹ç›®
    !layoutParamsChanged.value && // å¸ƒå±€å‚æ•°æœªå˜åŒ–
    allItemsLoaded.value // æ‰€æœ‰é¡¹ç›®å·²åŠ è½½

  if (canSwitch && mode.value === 'progressive') {
    switchToAlgorithmMode()
  }
}
```

### 3. æ•°æ®ä¸€è‡´æ€§éªŒè¯

```typescript
const validateConsistency = () => {
  // æ¯”è¾ƒDOMæ’ç‰ˆç»“æœå’Œç®—æ³•è®¡ç®—ç»“æœ
  const domResult = getDomLayoutResult()
  const algorithmResult = manager.updateParams(params.value)

  const isConsistent = domResult.items.every((domItem, index) => {
    const algItem = algorithmResult.items[index]
    return (
      Math.abs(domItem.top - algItem.top) < 1 &&
      Math.abs(domItem.left - algItem.left) < 1
    )
  })

  if (!isConsistent) {
    console.warn('DOMå’Œç®—æ³•ç»“æœä¸ä¸€è‡´ï¼Œå»ºè®®é‡æ–°ç”Ÿæˆå¿«ç…§')
  }

  return isConsistent
}
```

## å¯è¡Œæ€§è¯„ä¼°

### âœ… å¯è¡Œçš„éƒ¨åˆ†

1. **æŠ€æœ¯ä¸Šå®Œå…¨å¯è¡Œ** - ä¸¤å¥—ç³»ç»Ÿå¯ä»¥å…±å­˜
2. **æ€§èƒ½æå‡æ˜æ˜¾** - åˆ é™¤æ“ä½œä»å¼‚æ­¥DOMå˜ä¸ºåŒæ­¥è®¡ç®—
3. **ç”¨æˆ·ä½“éªŒå¥½** - åˆæ¬¡åŠ è½½å‡†ç¡®ï¼Œåç»­æ“ä½œæµç•…

### âš ï¸ éœ€è¦æ³¨æ„çš„æŒ‘æˆ˜

1. **å¤æ‚åº¦å¢åŠ ** - éœ€è¦ç»´æŠ¤ä¸¤å¥—ç³»ç»Ÿå’ŒåŒæ­¥é€»è¾‘
2. **å†…å­˜å¼€é”€** - éœ€è¦åŒæ—¶ä¿å­˜DOMçŠ¶æ€å’Œå¿«ç…§æ•°æ®
3. **è¾¹ç•Œæƒ…å†µ** - éœ€è¦å¤„ç†å„ç§å¼‚å¸¸å’Œå›é€€åœºæ™¯
4. **è°ƒè¯•éš¾åº¦** - ä¸¤å¥—ç³»ç»Ÿçš„é—®é¢˜å®šä½æ›´å¤æ‚

### ğŸ¯ å»ºè®®çš„å®ç°ä¼˜å…ˆçº§

1. **å…ˆå®ç°åŸºç¡€æ•´åˆ** - ç®€å•çš„DOMâ†’ç®—æ³•åˆ‡æ¢
2. **å®Œå–„åŒæ­¥æœºåˆ¶** - ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
3. **æ·»åŠ å›é€€é€»è¾‘** - å¤„ç†å¼‚å¸¸æƒ…å†µ
4. **æ€§èƒ½ä¼˜åŒ–** - å‡å°‘ä¸å¿…è¦çš„è®¡ç®—å’Œå­˜å‚¨

## æ€»ç»“

è¿™ä¸ªæ··åˆæ¶æ„è®¾è®¡**æŠ€æœ¯ä¸Šå®Œå…¨å¯è¡Œ**ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªå¾ˆæœ‰åˆ›æ–°æ€§çš„æ–¹æ¡ˆã€‚å…³é”®æ˜¯è¦ï¼š

1. **æ˜ç¡®åˆ‡æ¢æ—¶æœº** - ä»€ä¹ˆæ—¶å€™ç”¨DOMï¼Œä»€ä¹ˆæ—¶å€™ç”¨ç®—æ³•
2. **ä¿è¯æ•°æ®åŒæ­¥** - ä¸¤å¥—ç³»ç»Ÿçš„çŠ¶æ€è¦ä¸€è‡´
3. **å¤„ç†è¾¹ç•Œæƒ…å†µ** - å¼‚å¸¸æ—¶çš„å›é€€æœºåˆ¶
4. **æ¸è¿›å¼å®ç°** - å…ˆåšåŸºç¡€åŠŸèƒ½ï¼Œå†å®Œå–„ç»†èŠ‚

è¿™ç§æ··åˆæ¨¡å¼å¯ä»¥å……åˆ†å‘æŒ¥ä¸¤ç§æ–¹æ¡ˆçš„ä¼˜åŠ¿ï¼š

- **DOMæ¨¡å¼**ï¼šä¿è¯åˆæ¬¡æ’ç‰ˆçš„å‡†ç¡®æ€§å’Œå¯¹å¤æ‚å†…å®¹çš„æ”¯æŒ
- **ç®—æ³•æ¨¡å¼**ï¼šæä¾›åç»­æ“ä½œçš„é«˜æ€§èƒ½å’Œæµç•…ä½“éªŒ
- **æ¸è¿›å¼å¿«ç…§**ï¼šå®ç°æ— ç¼çš„æ¨¡å¼åˆ‡æ¢å’Œæ€§èƒ½ä¼˜åŒ–

æ˜¯ä¸€ä¸ªå¾ˆå€¼å¾—å°è¯•çš„æ¶æ„è®¾è®¡ï¼
