# 瀑布流组件Bug修复需求文档

## 介绍

本需求文档旨在解决瀑布流组件在tabbar页面快速切换时出现的布局错乱问题。该bug是由异步状态管理和生命周期处理不当导致的，当用户在瀑布流组件排列过程中快速切换页面时，异步操作会在错误的时机完成，导致组件状态被污染，最终呈现错乱的布局。这种情况有点极端，页面切换后 uni.createSelectorQuery() 获取不到正确节点信息，全部是0导致的，可能是BUG,也可能是页面都没准备好，uni也获取不到信息，实际测试，还有一种极极极极端情况，就是在一瞬间切走在切回来，应该是100毫秒之内，偶尔图片的高度也不准确，应该是图片刚渲染到一半，uni获取到的高度就是不准确的，这种是极极极极端情况了。

## 需求

### 需求 1：页面激活状态管理

**用户故事：** 作为开发者，我希望瀑布流组件能够正确感知页面的激活/失活状态，以便在页面切换时正确处理异步操作。

#### 验收标准

1. WHEN 页面被激活 THEN 瀑布流组件 SHALL 设置激活状态为true并重新初始化
2. WHEN 页面被失活 THEN 瀑布流组件 SHALL 设置激活状态为false并停止所有异步操作
3. WHEN 组件处于失活状态 THEN 所有异步操作 SHALL 被跳过或中断
4. WHEN 页面重新激活 THEN 组件状态 SHALL 被重置并重新计算布局

### 需求 2：异步操作中断机制

**用户故事：** 作为开发者，我希望能够中断正在进行的异步操作，以避免在页面切换后异步操作仍在后台执行导致状态污染。

#### 验收标准

1. WHEN 页面失活时 THEN 系统 SHALL 取消所有正在进行的异步操作
2. WHEN 异步操作被中断 THEN 系统 SHALL 不更新组件状态
3. WHEN 新的异步操作开始时 THEN 系统 SHALL 先取消之前的操作
4. IF 异步操作过程中页面失活 THEN 系统 SHALL 立即中断操作并清理资源

### 需求 3：状态重置和恢复机制

**用户故事：** 作为用户，我希望在页面切换后返回时，瀑布流能够正确显示，而不是出现布局错乱。

#### 验收标准

1. WHEN 页面重新激活时 THEN 系统 SHALL 重置所有项目的状态（loaded、visible、height、top、left）
2. WHEN 状态重置完成后 THEN 系统 SHALL 重新获取容器尺寸
3. WHEN 容器尺寸获取成功后 THEN 系统 SHALL 触发重新排版
4. WHEN 重新排版完成后 THEN 瀑布流 SHALL 正确显示所有已加载的项目

### 需求 4：DOM查询安全性增强

**用户故事：** 作为开发者，我希望DOM查询操作能够在正确的时机执行，并且能够处理查询失败的情况。需要注意uni.createSelectorQuery()这个api可能获取dom信息的延迟性。

#### 验收标准

1. WHEN 执行DOM查询前 THEN 系统 SHALL 检查组件是否已挂载且处于激活状态
2. WHEN DOM查询返回无效结果时 THEN 系统 SHALL 使用默认值而不是忽略
3. WHEN DOM查询失败时 THEN 系统 SHALL 记录错误并提供降级方案
4. IF 组件未激活 THEN DOM查询操作 SHALL 被跳过

### 需求 5：防御性编程增强

**用户故事：** 作为开发者，我希望组件能够在各种异常情况下保持稳定，不会因为单个异常导致整个组件崩溃。

#### 验收标准

1. WHEN 执行关键操作前 THEN 系统 SHALL 进行多重状态检查
2. WHEN 遇到异常情况时 THEN 系统 SHALL 提供合理的降级方案
3. WHEN 项目高度无效时 THEN 系统 SHALL 使用默认高度继续排版
4. WHEN 容器宽度无效时 THEN 系统 SHALL 跳过排版操作并记录警告

### 需求 6：调试和监控能力

**用户故事：** 作为开发者，我希望能够通过详细的日志了解组件的运行状态，便于问题排查和性能优化。

#### 验收标准

1. WHEN 组件状态发生变化时 THEN 系统 SHALL 记录详细的状态变化日志
2. WHEN 异步操作开始或结束时 THEN 系统 SHALL 记录操作的时间和结果
3. WHEN 发生错误时 THEN 系统 SHALL 记录错误的详细信息和上下文
4. WHEN 页面激活/失活时 THEN 系统 SHALL 记录页面状态变化和相关操作

### 需求 7：性能优化保持

**用户故事：** 作为用户，我希望在修复bug的同时，组件的性能不会受到明显影响。

#### 验收标准

1. WHEN 修复实施后 THEN 组件的渲染性能 SHALL 不低于修复前的90%
2. WHEN 添加状态检查时 THEN 检查操作 SHALL 使用高效的实现方式
3. WHEN 添加日志记录时 THEN 日志操作 SHALL 不影响主要业务逻辑的执行
4. WHEN 组件正常使用时 THEN 额外的安全检查 SHALL 不产生明显的性能开销
