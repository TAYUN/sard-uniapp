<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç€‘å¸ƒæµæœ€å°åˆ—é«˜åº¦è®¡ç®—Bugå¤ç°Demo</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .demo-container {
        max-width: 800px;
        margin: 0 auto;
      }
      .waterfall {
        position: relative;
        border: 2px solid #ddd;
        margin: 20px 0;
      }
      .waterfall-item {
        position: absolute;
        background: #f0f0f0;
        border: 1px solid #ccc;
        padding: 10px;
        box-sizing: border-box;
      }
      .controls {
        margin: 20px 0;
      }
      .controls button {
        margin: 5px;
        padding: 8px 16px;
      }
      .debug-info {
        background: #f9f9f9;
        padding: 15px;
        margin: 10px 0;
        border-left: 4px solid #007acc;
        font-family: monospace;
        white-space: pre-line;
      }
      .problem {
        background: #ffe6e6;
        border-left-color: #ff4444;
      }
      .solution {
        background: #e6ffe6;
        border-left-color: #44ff44;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="demo-container">
        <h1>ç€‘å¸ƒæµæœ€å°åˆ—é«˜åº¦è®¡ç®—Bugå¤ç°Demo</h1>

        <div class="debug-info problem">
          <strong>é—®é¢˜æè¿°ï¼š</strong>
          åœ¨ç€‘å¸ƒæµå¸ƒå±€ä¸­ï¼Œæœ‰æ—¶å€™æœ€å°åˆ—é«˜åº¦æ²¡æœ‰æ­£ç¡®ç´¯åŠ ï¼Œå¯¼è‡´é¡¹ç›®é‡å æˆ–å¸ƒå±€é”™ä¹±ã€‚

          <strong>é—®é¢˜åŸå› ï¼š</strong>
          1. è®¡ç®—å±æ€§ minColumn åœ¨å¼‚æ­¥å¾ªç¯ä¸­å¯èƒ½è¿”å›è¿‡æœŸçš„å¼•ç”¨ 2.
          Vueå“åº”å¼æ›´æ–°æœ‰å»¶è¿Ÿï¼Œå¯¼è‡´åˆ—é«˜åº¦çŠ¶æ€ä¸åŒæ­¥ 3.
          å¼•ç”¨å¤±æ•ˆï¼šæ›´æ–°åˆ—é«˜åº¦åï¼Œä¸‹æ¬¡å¾ªç¯çš„ minColumn å¯èƒ½è¿˜æŒ‡å‘æ—§çš„æœ€çŸ­åˆ—
        </div>

        <div class="controls">
          <button @click="addItems(5)">æ·»åŠ 5ä¸ªé¡¹ç›®</button>
          <button @click="addItems(10)">æ·»åŠ 10ä¸ªé¡¹ç›®</button>
          <button @click="clearItems">æ¸…ç©º</button>
          <button @click="toggleVersion">
            åˆ‡æ¢ç‰ˆæœ¬: {{ useBuggyVersion ? 'æœ‰Bugç‰ˆæœ¬' : 'ä¿®å¤ç‰ˆæœ¬' }}
          </button>
        </div>

        <!-- æœ‰Bugçš„ç‰ˆæœ¬ -->
        <div v-if="useBuggyVersion">
          <h2>âŒ æœ‰Bugç‰ˆæœ¬ - ä½¿ç”¨è®¡ç®—å±æ€§</h2>
          <buggy-waterfall
            ref="buggyWaterfall"
            :items="items"
            @debug="onDebug"
          ></buggy-waterfall>
        </div>

        <!-- ä¿®å¤åçš„ç‰ˆæœ¬ -->
        <div v-else>
          <h2>âœ… ä¿®å¤ç‰ˆæœ¬ - æ¯æ¬¡é‡æ–°è·å–æœ€çŸ­åˆ—</h2>
          <fixed-waterfall
            ref="fixedWaterfall"
            :items="items"
            @debug="onDebug"
          ></fixed-waterfall>
        </div>

        <div class="debug-info" v-if="debugInfo">
          <strong>è°ƒè¯•ä¿¡æ¯ï¼š</strong>
          {{ debugInfo }}
        </div>

        <div class="debug-info solution">
          <strong>è§£å†³æ–¹æ¡ˆï¼š</strong>
          1. ä¸è¦åœ¨å¼‚æ­¥å¾ªç¯ä¸­ä¾èµ–è®¡ç®—å±æ€§çš„å¼•ç”¨ 2. æ¯æ¬¡å¾ªç¯éƒ½é‡æ–°è°ƒç”¨
          getMinColumn() å‡½æ•° 3. ä½¿ç”¨æ˜ç¡®çš„åˆ—ç´¢å¼•å˜é‡ï¼Œé¿å…å¼•ç”¨æ··ä¹± 4.
          å¿…è¦æ—¶æ·»åŠ  nextTick() ç¡®ä¿å“åº”å¼æ›´æ–°å®Œæˆ
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, reactive, computed, nextTick } = Vue

      // æœ‰Bugçš„ç€‘å¸ƒæµç»„ä»¶
      const BuggyWaterfall = {
        props: ['items'],
        emits: ['debug'],
        setup(props, { emit }) {
          const columns = reactive([
            { colIndex: 0, height: 0 },
            { colIndex: 1, height: 0 },
            { colIndex: 2, height: 0 },
          ])
          const containerHeight = ref(0)
          const columnWidth = 120
          const columnGap = 10
          const rowGap = 10

          // ğŸ› é—®é¢˜æ‰€åœ¨ï¼šä½¿ç”¨è®¡ç®—å±æ€§è·å–æœ€çŸ­åˆ—
          const minColumn = computed(() => {
            let min = columns[0]
            for (let i = 1; i < columns.length; i++) {
              if (columns[i].height < min.height) {
                min = columns[i]
              }
            }
            return min
          })

          const layout = async () => {
            // é‡ç½®åˆ—é«˜åº¦
            columns.forEach((col) => (col.height = 0))

            let debugLog = 'æœ‰Bugç‰ˆæœ¬å¸ƒå±€è¿‡ç¨‹ï¼š\n'

            for (let i = 0; i < props.items.length; i++) {
              const item = props.items[i]

              // ğŸ› é—®é¢˜ï¼šåœ¨å¾ªç¯ä¸­ä½¿ç”¨è®¡ç®—å±æ€§çš„å¼•ç”¨
              const currentMin = minColumn.value
              debugLog += `é¡¹ç›®${i}: é€‰æ‹©åˆ—${currentMin.colIndex}(é«˜åº¦${currentMin.height}) `

              item.top = currentMin.height + rowGap
              item.left = (columnGap + columnWidth) * currentMin.colIndex

              // ğŸ› é—®é¢˜ï¼šæ›´æ–°åˆ—é«˜åº¦ï¼Œä½†ä¸‹æ¬¡å¾ªç¯minColumn.valueå¯èƒ½è¿˜æ˜¯æ—§å¼•ç”¨
              columns[currentMin.colIndex].height = item.top + item.height

              debugLog += `-> æ›´æ–°åé«˜åº¦${columns[currentMin.colIndex].height}\n`

              // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
              await new Promise((resolve) => setTimeout(resolve, 1))
            }

            containerHeight.value = Math.max(
              ...columns.map((col) => col.height),
            )
            debugLog += `\næœ€ç»ˆåˆ—é«˜åº¦: ${columns.map((col) => col.height).join(', ')}`
            emit('debug', debugLog)
          }

          return { columns, containerHeight, columnWidth, layout }
        },
        template: `
                <div class="waterfall" :style="{ height: containerHeight + 'px' }" @click="layout">
                    <div 
                        v-for="(item, index) in items" 
                        :key="index"
                        class="waterfall-item"
                        :style="{ 
                            width: columnWidth + 'px', 
                            height: item.height + 'px',
                            left: item.left + 'px',
                            top: item.top + 'px',
                            backgroundColor: item.color
                        }"
                    >
                        é¡¹ç›® {{ index }} ({{ item.height }}px)
                    </div>
                    <div style="position: absolute; bottom: 5px; right: 5px; font-size: 12px;">
                        ç‚¹å‡»é‡æ–°å¸ƒå±€
                    </div>
                </div>
            `,
      }

      // ä¿®å¤åçš„ç€‘å¸ƒæµç»„ä»¶
      const FixedWaterfall = {
        props: ['items'],
        emits: ['debug'],
        setup(props, { emit }) {
          const columns = reactive([
            { colIndex: 0, height: 0 },
            { colIndex: 1, height: 0 },
            { colIndex: 2, height: 0 },
          ])
          const containerHeight = ref(0)
          const columnWidth = 120
          const columnGap = 10
          const rowGap = 10

          // âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨å‡½æ•°è€Œä¸æ˜¯è®¡ç®—å±æ€§
          const getMinColumn = () => {
            let min = columns[0]
            for (let i = 1; i < columns.length; i++) {
              if (columns[i].height < min.height) {
                min = columns[i]
              }
            }
            return min
          }

          const layout = async () => {
            // é‡ç½®åˆ—é«˜åº¦
            columns.forEach((col) => (col.height = 0))

            let debugLog = 'ä¿®å¤ç‰ˆæœ¬å¸ƒå±€è¿‡ç¨‹ï¼š\n'

            for (let i = 0; i < props.items.length; i++) {
              const item = props.items[i]

              // âœ… è§£å†³æ–¹æ¡ˆï¼šæ¯æ¬¡å¾ªç¯éƒ½é‡æ–°è·å–æœ€çŸ­åˆ—
              const currentMin = getMinColumn()
              debugLog += `é¡¹ç›®${i}: é€‰æ‹©åˆ—${currentMin.colIndex}(é«˜åº¦${currentMin.height}) `

              item.top = currentMin.height + rowGap
              item.left = (columnGap + columnWidth) * currentMin.colIndex

              // âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æ˜ç¡®çš„åˆ—ç´¢å¼•
              const targetColumnIndex = currentMin.colIndex
              const newHeight = item.top + item.height
              columns[targetColumnIndex].height = newHeight

              debugLog += `-> æ›´æ–°åé«˜åº¦${newHeight}\n`

              // âœ… è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿å“åº”å¼æ›´æ–°å®Œæˆ
              await nextTick()
            }

            containerHeight.value = Math.max(
              ...columns.map((col) => col.height),
            )
            debugLog += `\næœ€ç»ˆåˆ—é«˜åº¦: ${columns.map((col) => col.height).join(', ')}`
            emit('debug', debugLog)
          }

          return { columns, containerHeight, columnWidth, layout }
        },
        template: `
                <div class="waterfall" :style="{ height: containerHeight + 'px' }" @click="layout">
                    <div 
                        v-for="(item, index) in items" 
                        :key="index"
                        class="waterfall-item"
                        :style="{ 
                            width: columnWidth + 'px', 
                            height: item.height + 'px',
                            left: item.left + 'px',
                            top: item.top + 'px',
                            backgroundColor: item.color
                        }"
                    >
                        é¡¹ç›® {{ index }} ({{ item.height }}px)
                    </div>
                    <div style="position: absolute; bottom: 5px; right: 5px; font-size: 12px;">
                        ç‚¹å‡»é‡æ–°å¸ƒå±€
                    </div>
                </div>
            `,
      }

      createApp({
        components: {
          BuggyWaterfall,
          FixedWaterfall,
        },
        setup() {
          const items = ref([])
          const useBuggyVersion = ref(true)
          const debugInfo = ref('')

          const colors = [
            '#ffcccb',
            '#add8e6',
            '#90ee90',
            '#ffd700',
            '#dda0dd',
            '#f0e68c',
          ]

          const addItems = (count) => {
            for (let i = 0; i < count; i++) {
              items.value.push({
                height: Math.floor(Math.random() * 100) + 50, // 50-150pxéšæœºé«˜åº¦
                color: colors[Math.floor(Math.random() * colors.length)],
                top: 0,
                left: 0,
              })
            }
            // è‡ªåŠ¨è§¦å‘å¸ƒå±€
            setTimeout(() => {
              const waterfall = useBuggyVersion.value
                ? document.querySelector('.waterfall')
                : document.querySelector('.waterfall')
              if (waterfall) waterfall.click()
            }, 100)
          }

          const clearItems = () => {
            items.value = []
            debugInfo.value = ''
          }

          const toggleVersion = () => {
            useBuggyVersion.value = !useBuggyVersion.value
            debugInfo.value = ''
          }

          const onDebug = (info) => {
            debugInfo.value = info
          }

          // åˆå§‹åŒ–ä¸€äº›é¡¹ç›®
          addItems(8)

          return {
            items,
            useBuggyVersion,
            debugInfo,
            addItems,
            clearItems,
            toggleVersion,
            onDebug,
          }
        },
      }).mount('#app')
    </script>
  </body>
</html>
